<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>FastAPI & MurfAI</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-900 text-white">
        <div class="min-h-screen flex items-center justify-center gap-4">
            <div
                class="bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-xl p-8 rounded-2xl shadow-2xl border border-gray-700 max-w-md w-full text-center"
            >
                <h1 class="text-4xl font-bold mb-2 select-none">
                    üéôÔ∏èText to Speech
                </h1>
                <p class="mb-4 text-gray-400 select-none">
                    Transform your text into speech
                </p>
                <form id="ttsForm" class="flex flex-col items-center">
                    <textarea
                        id="userInput"
                        class="w-full h-36 p-2 mb-4 border border-gray-700 rounded-lg bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        rows="4"
                        placeholder="Enter your text..."
                        style="
                            scrollbar-width: thin;
                            scrollbar-color: #4f46e5 transparent;
                        "
                        required
                    ></textarea>
                    <button
                        id="submitBtn"
                        class="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center justify-center gap-2 w-fit mx-auto"
                        type="submit"
                    >
                        <span id="btnText">Generate Speech</span>
                        <span
                            id="btnLoader"
                            class="loader hidden animate-spin border-2 border-t-transparent border-white rounded-full w-4 h-4"
                        ></span>
                    </button>
                </form>

                <div id="audio-container" class="mt-6 flex justify-center">
                    <audio id="audioPlayer" controls autoplay>
                        <source id="audioSource" src="" type="audio/mpeg" />
                        Your browser does not support the audio element.
                    </audio>
                </div>

            </div>
            <div class="bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-xl p-8 rounded-2xl shadow-2xl border border-gray-700 text-center">
                <h2 class="text-2xl font-bold mb-4 text-center select-none">
                    Echo Bot
                </h2>
                <div class="gap-4 justify-center">
                    <button
                        id="record"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    >
                        Record
                    </button>
                    <button
                        id="stop"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    >
                        Stop
                    </button>
                    <button
                        id="reset"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    >
                        Reset
                    </button>
                </div>
                <div id="record-container" class="mt-4 flex justify-center">
                    <audio id="recordedAudio" controls>
                        <source id="recordedAudioSource" src="" type="audio/ogg" />
                    </audio>
                </div>

                <div id="uploadStatus" class="upload-status mt-4 p-3 rounded-lg text-sm font-medium hidden"></div>
            </div>

        <script src="static/script.js"></script>
        <script>
            if (navigator.mediaDevices) {
                const constraints = { audio: true };
                let chunks = [];

                navigator.mediaDevices
                    .getUserMedia(constraints)
                    .then((stream) => {
                        const mediaRecorder = new MediaRecorder(stream);
                        const record = document.getElementById("record");
                        const stop = document.getElementById("stop");
                        const reset = document.getElementById("reset");
                        const audioPlayer = document.getElementById("recordedAudio");
                        const audioSource = document.getElementById("recordedAudioSource");

                        record.onclick = () => {
                            chunks = [];
                            mediaRecorder.start();
                            record.classList.add("opacity-50");
                            updateUploadStatus("Recording...", "info");
                        };

                        stop.onclick = () => {
                            mediaRecorder.stop();
                            record.classList.remove("opacity-50");
                            updateUploadStatus("Processing recording...", "info");
                        };

                        reset.onclick = () => {
                            chunks = [];
                            audioSource.src = "";
                            audioPlayer.load();
                            record.classList.remove("opacity-50");
                            updateUploadStatus("", "");
                        };

                        mediaRecorder.ondataavailable = (e) => {
                            chunks.push(e.data);
                        };

                        mediaRecorder.onstop = async () => {
                            const blob = new Blob(chunks, {
                                type: "audio/ogg; codecs=opus",
                            });

                            await uploadAudio(blob);
                        };

                        async function uploadAudio(audioBlob) {
                            updateUploadStatus("Uploading audio...", "info");
                            
                            const formData = new FormData();
                            formData.append("file", audioBlob, "recording.ogg");
                            
                            try {
                                const response = await fetch("/upload", {
                                    method: "POST",
                                    body: formData,
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    updateUploadStatus(
                                        `<b>Upload successful!</b><br>File: ${result.filename}<br>Size: ${(result.size/Number(1024)).toFixed(2)} KB<br>Type: ${result.content_type}`,
                                        "success"
                                    );
                                    
                                    // Play the uploaded audio from server
                                    audioSource.src = `/uploads/${result.filename}`;
                                    audioPlayer.load();
                                    audioPlayer.play();
                                } else {
                                    const errorData = await response.json();
                                    updateUploadStatus(`Upload failed: ${errorData.detail}`, "error");
                                    
                                    // Fallback: play local recording
                                    const audioURL = URL.createObjectURL(audioBlob);
                                    audioSource.src = audioURL;
                                    audioPlayer.load();
                                    audioPlayer.play();
                                }
                            } catch (err) {
                                console.error("Upload error:", err);
                                updateUploadStatus("Upload failed: Network error", "error");
                                
                                // Fallback: play local recording
                                const audioURL = URL.createObjectURL(audioBlob);
                                audioSource.src = audioURL;
                                audioPlayer.load();
                                audioPlayer.play();
                            }
                        }

                        // Status update function
                        function updateUploadStatus(message, type) {
                            let statusElement = document.getElementById("uploadStatus");
                            if (!statusElement) {
                                // Create status element if it doesn't exist
                                statusElement = document.createElement("div");
                                statusElement.id = "uploadStatus";
                                statusElement.className = "upload-status mt-4 p-3 rounded-lg text-sm font-medium";
                                document.querySelector(".border-t.border-gray-700").appendChild(statusElement);
                            }
                            statusElement.innerHTML = message;
                            statusElement.className = `upload-status mt-4 p-3 rounded-lg text-sm font-medium ${getStatusClass(type)}`;
                        }

                        function getStatusClass(type) {
                            switch(type) {
                                case "info":
                                    return "bg-blue-500 bg-opacity-20 text-blue-300 border border-blue-500 border-opacity-30";
                                case "success":
                                    return "bg-green-500 bg-opacity-20 text-green-300 border border-green-500 border-opacity-30";
                                case "error":
                                    return "bg-red-500 bg-opacity-20 text-red-300 border border-red-500 border-opacity-30";
                                default:
                                    return "hidden";
                            }
                        }
                    })
                    .catch((err) => {
                        console.error("The following error occurred: " + err);
                        updateUploadStatus("Error accessing microphone", "error");
                    });
            }
        </script>
    </body>
</html>
